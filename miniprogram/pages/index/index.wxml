<!-- èŠå¤©åŠ©æ‰‹é¡µé¢ -->
<view class="container" bindtap="hideSettingsMenu">
  <!-- Chat History -->
  <scroll-view class="chat-history" scroll-y scroll-into-view="{{lastMessageId}}" scroll-with-animation="{{true}}" enhanced="{{true}}" show-scrollbar="{{false}}" bounces="{{true}}" scroll-anchoring="{{true}}" refresher-enabled="{{false}}">
    <view class="messages">
      <block wx:for="{{chatHistory}}" wx:key="id">
        <view class="message {{item.role}}" id="msg-{{item.id}}">
          <text class="message-text">{{item.content}}</text>
          <text class="message-hint" wx:if="{{item.hint}}">{{item.hint}}</text>
          <!-- Feature Buttons -->
          <view class="feature-buttons" wx:if="{{item.buttons && item.buttons.length > 0}}">
            <view wx:for="{{item.buttons}}" wx:for-item="button" wx:key="id" class="feature-button" bindtap="handleFeatureButtonTap" data-feature="{{button.feature}}">
              <text class="feature-button-text">{{button.name}}</text>
              <image wx:if="{{button.image}}" class="feature-button-image" src="{{button.image}}" mode="aspectFit"></image>
            </view>
          </view>
        </view>
      </block>
      <!-- Current Recognition Text - only show when not already in chat history -->
      <view class="message user" wx:if="{{debugRecognizedText && isRecording}}">
        <text class="message-text">"{{debugRecognizedText}}"</text>
      </view>
      <!-- AI Response - only show when not already in chat history -->
      <view class="message assistant" wx:if="{{debugDeepseekResponse && debugDeepseekResponse !== 'æ€è€ƒä¸­...' && isWaitingForDeepseek}}">
        <text class="message-text">{{debugDeepseekResponse}}</text>
      </view>
      <!-- Editable Text Input Field -->
      <view class="message user text-input-container" wx:if="{{!isWaitingForDeepseek}}" catchtap="preventBubble">
        <view wx:if="{{!isEditing}}" class="text-input-prompt" bindtap="showTextInput">
          {{isSpeaking ? 'ç‚¹å‡»æ‰“æ–­å¹¶è¾“å…¥æ–‡å­—' : (isRecording ? 'ç‚¹å‡»æ‰“æ–­å¹¶è¾“å…¥æ–‡å­—' : 'ç‚¹å‡»è¾“å…¥æ–‡å­—')}}
        </view>
        <view wx:if="{{isEditing}}" class="text-input-active-container">
          <input class="text-input" value="{{debugRecognizedText}}" bindinput="onTextInputChange" focus="{{isEditing}}" confirm-type="send" bindconfirm="sendEditedText" />
          <button wx:if="{{debugRecognizedText.trim().length > 0}}" class="text-send-button" bindtap="sendEditedText">
            å‘é€
          </button>
        </view>
      </view>
    </view>
  </scroll-view>
  <!-- Bottom Orb Area -->
  <view class="orb-container">
    <view class="orb {{orbState}}" bindtap="handleOrbTap">
      <view class="orb-inner">
        <image class="dog-avatar" src="/assets/icons/dog.jpg" mode="aspectFill" />
      </view>
      <view class="orb-outer"></view>
    </view>
    <view class="orb-instruction">
      {{isRecording ? 'æ­£åœ¨è†å¬...' : (isSpeaking ? 'æ­£åœ¨è¯´è¯...' : 'è½»è§¦å¼€å§‹')}}
    </view>
  </view>
  <!-- è®¾ç½®æŒ‰é’®å’Œèœå• -->
  <view class="settings-container">
    <!-- è®¾ç½®èœå• -->
    <view class="settings-menu {{showSettings ? 'show' : ''}}" catchtap="preventBubble">
      <!-- æ¨¡å‹åˆ‡æ¢æŒ‰é’® -->
      <view class="settings-item" bindtap="switchAiModel">
        <text>AIæ¨¡å‹: {{currentAiModel}}</text>
      </view>
      <!-- è¯­éŸ³å¼•æ“åˆ‡æ¢æŒ‰é’® -->
      <view class="settings-item" bindtap="switchTtsProvider">
        <text>è¯­éŸ³å¼•æ“: {{currentTtsProvider === 'ali' ? 'é˜¿é‡Œäº‘' : 'CosyVoice'}}</text>
      </view>
      <!-- Debugæ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
      <view class="settings-item" bindtap="toggleDebugMode">
        <text>è°ƒè¯•æ¨¡å¼: {{isDebugMode ? 'å¼€å¯' : 'å…³é—­'}}</text>
      </view>
    </view>
    <!-- Debugæ¨¡å¼æŒ‡ç¤ºå™¨ -->
    <view class="debug-button {{isDebugMode ? 'active' : ''}}" catchtap="toggleDebugMode">
      <text>ğŸ</text>
    </view>
    <!-- è®¾ç½®æŒ‰é’® -->
    <view class="settings-button" catchtap="toggleSettingsMenu">
      <image src="/assets/icons/index/settings.svg" mode="aspectFit"></image>
    </view>
  </view>
</view>