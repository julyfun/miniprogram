<!-- èŠå¤©åŠ©æ‰‹é¡µé¢ -->
<view class="container" bindtap="hideSettingsMenu">
  <!-- èƒŒæ™¯å›¾ç‰‡ -->
  <image class="bg-image" src="cloud://cloud1-6g9ht8y6f2744311.636c-cloud1-6g9ht8y6f2744311-1350392348/assets/images/bg2.jpg" mode="aspectFill"></image>
  <!-- ç™»å½•æç¤ºæ¨ªå¹… - æœªç™»å½•æ—¶æ˜¾ç¤º -->
  <view class="login-banner" wx:if="{{!isLogged}}" catchtap="login">
    <image class="login-icon" src="/assets/icons/user.svg" mode="aspectFit"></image>
    <text class="login-text">ç™»å½•åå¯ä¿å­˜å­¦ä¹ è¿›åº¦</text>
    <button class="login-button">ç«‹å³ç™»å½•</button>
  </view>
  <!-- å­¦ä¹ è¿›åº¦å¡ç‰‡ -->
  <view class="progress-card" wx:if="{{showLearningProgress}}">
    <view class="progress-header">
      <text class="progress-title">è¯ˆéª—é˜²èŒƒè¯¾ç¨‹è¿›åº¦</text>
      <text class="progress-counter">{{learningProgress.totalCompleted || 0}}/3</text>
    </view>
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{(learningProgress.totalCompleted || 0) * 33.33}}%;"></view>
    </view>
    <!-- ç™»å½•çŠ¶æ€æç¤º -->
    <view class="login-status" wx:if="{{!isLogged}}" bindtap="login">
      <text class="login-prompt">ç™»å½•åå¯ä¿å­˜å­¦ä¹ è¿›åº¦ - ç‚¹å‡»ç™»å½•</text>
    </view>
    <view class="progress-modules">
      <view class="module-item {{learningProgress && learningProgress.modules && learningProgress.modules['scam_call'] && learningProgress.modules['scam_call'].completed ? 'completed' : ''}}" bindtap="navigateToModule" data-module="scam_call">
        <image class="module-icon" src="/assets/icons/{{learningProgress && learningProgress.modules && learningProgress.modules['scam_call'] && learningProgress.modules['scam_call'].completed ? 'check' : 'lock'}}.svg" />
        <text class="module-name">è¯ˆéª—æ¥ç”µé˜²èŒƒ</text>
      </view>
      <view class="module-item {{learningProgress && learningProgress.modules && learningProgress.modules['scam_call2'] && learningProgress.modules['scam_call2'].completed ? 'completed' : ''}}" bindtap="navigateToModule" data-module="scam_call2">
        <image class="module-icon" src="/assets/icons/{{learningProgress && learningProgress.modules && learningProgress.modules['scam_call2'] && learningProgress.modules['scam_call2'].completed ? 'check' : 'lock'}}.svg" />
        <text class="module-name">äº²å±æ±‚åŠ©è¯ˆéª—</text>
      </view>
      <view class="module-item {{learningProgress && learningProgress.modules && learningProgress.modules['scam_call3'] && learningProgress.modules['scam_call3'].completed ? 'completed' : ''}}" bindtap="navigateToModule" data-module="scam_call3">
        <image class="module-icon" src="/assets/icons/{{learningProgress && learningProgress.modules && learningProgress.modules['scam_call3'] && learningProgress.modules['scam_call3'].completed ? 'check' : 'lock'}}.svg" />
        <text class="module-name">å†’å……å…¬æ£€æ³•è¯ˆéª—</text>
      </view>
    </view>
    <view class="progress-actions">
      <button class="refresh-button" bindtap="refreshLearningProgress">åˆ·æ–°</button>
      <button class="reset-button" bindtap="resetLearningProgress">é‡ç½®è¿›åº¦</button>
    </view>
  </view>
  <!-- Chat History -->
  <scroll-view class="chat-history" scroll-y scroll-into-view="{{lastMessageId}}" scroll-with-animation="{{true}}" enhanced="{{true}}" show-scrollbar="{{false}}" bounces="{{true}}" scroll-anchoring="{{true}}" refresher-enabled="{{false}}">
    <view class="messages">
      <block wx:for="{{chatHistory}}" wx:key="id">
        <view class="message {{item.role}}" id="msg-{{item.id}}">
          <text class="message-text">{{item.content}}</text>
          <text class="message-hint" wx:if="{{item.hint}}">{{item.hint}}</text>
          <!-- Feature Buttons -->
          <view class="feature-buttons" wx:if="{{item.buttons && item.buttons.length > 0}}">
            <view wx:for="{{item.buttons}}" wx:for-item="button" wx:key="id" class="feature-button" bindtap="handleFeatureButtonTap" data-feature="{{button.feature}}">
              <text class="feature-button-text">{{button.name}}</text>
              <image wx:if="{{button.image}}" class="feature-button-image" src="{{button.image}}" mode="aspectFit"></image>
            </view>
          </view>
        </view>
      </block>
      <!-- Current Recognition Text - only show when not already in chat history -->
      <view class="message user" wx:if="{{debugRecognizedText && isRecording}}">
        <text class="message-text">"{{debugRecognizedText}}"</text>
      </view>
      <!-- AI Response - only show when not already in chat history -->
      <view class="message assistant" wx:if="{{debugDeepseekResponse && debugDeepseekResponse !== 'æ€è€ƒä¸­...' && isWaitingForDeepseek}}">
        <text class="message-text">{{debugDeepseekResponse}}</text>
      </view>
      <!-- Editable Text Input Field -->
      <view class="message user text-input-container" wx:if="{{!isWaitingForDeepseek}}" catchtap="preventBubble">
        <view wx:if="{{!isEditing}}" class="text-input-prompt" bindtap="showTextInput">
          {{isSpeaking ? 'ç‚¹å‡»æ‰“æ–­å¹¶è¾“å…¥æ–‡å­—' : (isRecording ? 'ç‚¹å‡»æ‰“æ–­å¹¶è¾“å…¥æ–‡å­—' : 'ç‚¹å‡»è¾“å…¥æ–‡å­—')}}
        </view>
        <view wx:if="{{isEditing}}" class="text-input-active-container">
          <input class="text-input" value="{{debugRecognizedText}}" bindinput="onTextInputChange" focus="{{isEditing}}" confirm-type="send" bindconfirm="sendEditedText" />
          <button wx:if="{{debugRecognizedText.trim().length > 0}}" class="text-send-button" bindtap="sendEditedText">
            å‘é€
          </button>
        </view>
      </view>
    </view>
  </scroll-view>
  <!-- Bottom Orb Area -->
  <view class="orb-container">
    <view class="orb {{orbState}}" bindtap="handleOrbTap">
      <view class="orb-inner">
        <image class="dog-avatar" src="/assets/icons/dog.jpg" mode="aspectFill" />
      </view>
      <view class="orb-outer"></view>
    </view>
    <view class="orb-instruction">
      {{isRecording ? 'æ­£åœ¨è†å¬...' : (isSpeaking ? 'æ­£åœ¨è¯´è¯...' : 'è½»è§¦å¼€å§‹')}}
    </view>
  </view>
  <!-- è®¾ç½®æŒ‰é’®å’Œèœå• -->
  <view class="settings-container">
    <!-- è®¾ç½®èœå• -->
    <view class="settings-menu {{showSettings ? 'show' : ''}}" catchtap="preventBubble">
      <!-- ç™»å½•çŠ¶æ€åŒºåŸŸ -->
      <view class="settings-user-section">
        <block wx:if="{{isLogged}}">
          <view class="settings-user-info">
            <image class="settings-avatar" src="{{userInfo.avatarUrl || '/assets/icons/default-avatar.svg'}}" mode="aspectFill"></image>
            <text class="settings-username">{{userInfo.nickName || 'å·²ç™»å½•ç”¨æˆ·'}}</text>
          </view>
        </block>
        <block wx:else>
          <view class="settings-login-prompt" bindtap="login">
            <image class="settings-login-icon" src="/assets/icons/default-avatar.svg" mode="aspectFill"></image>
            <text class="settings-login-text">ç‚¹å‡»ç™»å½•è´¦å·</text>
          </view>
        </block>
      </view>
      <!-- è®¾ç½®é€‰é¡¹åˆ†éš”çº¿ -->
      <view class="settings-divider"></view>
      <!-- å…¶ä»–è®¾ç½®é¡¹ -->
      <view class="settings-item" bindtap="toggleLearningProgress">
        <text>å­¦ä¹ è¿›åº¦: {{showLearningProgress ? 'éšè—' : 'æ˜¾ç¤º'}}</text>
      </view>
      <view class="settings-item" bindtap="switchAiModel">
        <text>AIæ¨¡å‹: {{currentAiModel}}</text>
      </view>
      <view class="settings-item" bindtap="switchTtsProvider">
        <text>è¯­éŸ³å¼•æ“: {{currentTtsProvider === 'ali' ? 'é˜¿é‡Œäº‘' : 'CosyVoice'}}</text>
      </view>
      <view class="settings-item" bindtap="toggleDebugMode">
        <text>è°ƒè¯•æ¨¡å¼: {{isDebugMode ? 'å¼€å¯' : 'å…³é—­'}}</text>
      </view>
    </view>
    <!-- Debugæ¨¡å¼æŒ‡ç¤ºå™¨ -->
    <view class="debug-button {{isDebugMode ? 'active' : ''}}" catchtap="toggleDebugMode">
      <text>ğŸ</text>
    </view>
    <!-- è®¾ç½®æŒ‰é’® -->
    <view class="settings-button" catchtap="toggleSettingsMenu">
      <image src="/assets/icons/index/settings.svg" mode="aspectFit"></image>
    </view>
  </view>
</view>